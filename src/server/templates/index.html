<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AA FAQ Chatbot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#0a89c3',
            secondary: '#F5F5F5',
            accent: '#0763af',
            charcoal: '#333333',
            'medium-gray': '#666666',
            'soft-white': '#FAFAFA'
          },
          fontFamily: {
            sans: ['Inter', 'Roboto', 'sans-serif']
          },
          animation: {
            bounce: 'bounce 1s infinite'
          },
          keyframes: {
            bounce: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-5px)' }
            }
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      background-color: #FAFAFA;
    }

    .chat-container {
      height: calc(100vh - 180px);
    }

    .message {
      max-width: 80%;
      border-radius: 18px;
    }

    .user-message {
      border-bottom-right-radius: 4px;
    }

    .bot-message {
      border-bottom-left-radius: 4px;
    }

    .feedback-icons i {
      cursor: pointer;
      transition: color 0.2s ease, transform 0.2s ease;
    }

    .feedback-icons i:hover {
      transform: scale(1.1);
    }

    .feedback-disabled i {
      opacity: 0.5;
      pointer-events: none;
    }
  </style>
</head>
<body class="bg-slate-200 text-charcoal">
  <!-- Header -->
  <header class="bg-primary text-white py-4 px-4 md:px-8 shadow-md">
    <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
      <div class="flex items-center mb-4 md:mb-0">
        <div class="bg-accent p-3 rounded-full mr-4 pulse">
          <i class="fas fa-comments text-white text-2xl"></i>
        </div>
        <div>
          <h1 class="text-2xl font-bold">AA FAQ Chatbot</h1>
          <p class="text-soft-white text-sm">Support and Information at Your Fingertips</p>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="container mx-auto min-h-screen px-4 py-6">
    <div class="flex justify-center flex-col md:flex-row gap-6 relative">
      <div class="w-full md:w-2/3 flex flex-col">
        <div class="bg-white rounded-xl shadow-md overflow-hidden flex flex-col h-full">
          <div class="bg-primary p-4 relative">
            <h2 class="text-xl font-bold text-white">AA FAQ Chatbot</h2>
            <p class="text-soft-white text-sm">Ask questions about AA, find meetings, or get support</p>
            <i id="clear-chat"
               class="fa fa-trash text-white cursor-pointer absolute top-6 right-6 text-2xl hidden hover:text-red-500 transition"
               title="Clear Chat History"></i>
          </div>

          <div class="chat-container overflow-y-auto p-4 bg-secondary flex-1">
            <div class="space-y-4"></div>
          </div>

          <div class="p-4 bg-white border-t border-gray-200">
            <div class="flex">
              <input type="text"
                     class="flex-1 border border-gray-300 rounded-l-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                     placeholder="Type your question here...">
              <button id="send-button"
                      class="bg-primary hover:bg-sky-400 text-white font-semibold py-3 px-6 rounded-r-lg transition">
                Send
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const chatContainer = document.querySelector('.chat-container');
      const inputField = document.querySelector('input[type="text"]');
      const sendButton = document.querySelector('#send-button');
      const clearChatButton = document.querySelector('#clear-chat');

      const history = storageHistory().get();
      history.forEach(chat => {
        if (chat.type === 'user') renderChat().userMessage(chat.text);
        else if (chat.type === 'bot') renderChat().botMessage(chat.text);
      });
      if (history.length > 0) clearChatButton.classList.remove('hidden');

      async function sendMessage() {
        const message = inputField.value.trim();
        if (!message) return;

        inputField.disabled = true;
        sendButton.disabled = true;
        inputField.value = '';

        renderChat().userMessage(message);
        const loader = `
          <div class="typing-animation flex space-x-1">
            <div class="typing-dot w-2 h-2 bg-accent rounded-full animate-bounce"></div>
            <div class="typing-dot w-2 h-2 bg-accent rounded-full animate-bounce delay-75"></div>
            <div class="typing-dot w-2 h-2 bg-accent rounded-full animate-bounce delay-150"></div>
          </div>
        `;
        const botDiv = document.createElement('div');
        botDiv.className = 'flex justify-start';
        const botMsg = document.createElement('div');
        botMsg.className = 'message bg-white p-4 rounded-2xl rounded-tl-none';
        botMsg.innerHTML = loader;
        botDiv.appendChild(botMsg);
        document.querySelector('.chat-container .space-y-4').appendChild(botDiv);
        await sendPrompt(message, botMsg);
      }

      async function sendPrompt(prompt, botDiv) {
        try {
            const response = await fetch("/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ query: prompt })
            });
            const data = await response.json();
            const answer = data.answer || data.error || "No response";
            const traceId = data.trace_id || null;  // <- recibimos el trace_id
            const html = DOMPurify.sanitize(marked.parse(answer));
            botDiv.innerHTML = html;

            // Add feedback icons
            const feedbackDiv = document.createElement("div");
            feedbackDiv.className = "feedback-icons mt-3 flex gap-3 text-gray-400 text-lg";
            feedbackDiv.innerHTML = `
                <i class="fa-regular fa-thumbs-up hover:text-green-500" data-feedback="positive"></i>
                <i class="fa-regular fa-thumbs-down hover:text-red-500" data-feedback="negative"></i>
            `;
            botDiv.appendChild(feedbackDiv);

            feedbackDiv.addEventListener("click", async (e) => {
                const target = e.target;
                if (!target.dataset.feedback) return;

                const feedback = target.dataset.feedback;
                await sendFeedback(feedback, prompt, answer, traceId);

                feedbackDiv.classList.add("feedback-disabled");
                target.classList.add(feedback === "positive" ? "text-green-500" : "text-red-500");
            });

            storageHistory().append({ type: 'user', text: prompt });
            storageHistory().append({ type: 'bot', text: answer });

            inputField.disabled = false;
            sendButton.disabled = false;
            clearChatButton.classList.remove('hidden');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        } catch (error) {
            console.error("Error:", error);
            botDiv.innerHTML = "Error: could not fetch response.";
            inputField.disabled = false;
            sendButton.disabled = false;
        }
      }

      async function sendFeedback(feedback, question, answer, traceId) {
        try {
            await fetch("/feedback", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ feedback, question, answer, trace_id: traceId })
            });
        } catch (err) {
            console.error("Error sending feedback:", err);
        }
      }

      sendButton.addEventListener('click', sendMessage);
      inputField.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });
      clearChatButton.addEventListener('click', function() {
        const messagesContainer = document.querySelector('.chat-container .space-y-4');
        if (messagesContainer) messagesContainer.innerHTML = '';
        chatContainer.scrollTop = chatContainer.scrollHeight;
        storageHistory().clear();
        clearChatButton.classList.add('hidden');
      });

      function renderChat() {
        const chatContainer = document.querySelector('.chat-container .space-y-4');
        const createDiv = (className) => {
          const div = document.createElement('div');
          div.className = className;
          return div;
        };
        return {
          userMessage: function(message) {
            const userDiv = createDiv('flex justify-end');
            userDiv.innerHTML = `<div class="message bg-primary text-white p-4 rounded-2xl rounded-tr-none">${message}</div>`;
            chatContainer.appendChild(userDiv);
          },
          botMessage: function(message) {
            const botDiv = createDiv('flex justify-start');
            const botMsg = createDiv('message bg-white p-4 rounded-2xl rounded-tl-none');
            botMsg.innerHTML = message;
            botDiv.appendChild(botMsg);
            chatContainer.appendChild(botDiv);
          }
        };
      }
    });

    function storageHistory() {
      const key = 'chat-history';
      return {
        get() { return JSON.parse(localStorage.getItem(key) || '[]'); },
        append(value) {
          const history = JSON.parse(localStorage.getItem(key) || '[]');
          history.push(value);
          localStorage.setItem(key, JSON.stringify(history));
        },
        clear() { localStorage.removeItem(key); }
      }
    }
  </script>
</body>
</html>
